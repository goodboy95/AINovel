# AI Novel - AI 小说创作平台

## 项目简介

AI Novel 是一个专为小说创作者打造的智能写作助手。它利用先进的 AI 技术，帮助用户从灵感构思、大纲设计到正文创作，提供全方位的支持，旨在提升创作效率和故事质量。

## 主要功能

### 第一期功能
*   **故事构思:** 根据用户输入的核心创意，生成故事摘要、主要角色和世界观设定。
*   **大纲设计:** 辅助用户创建和管理故事大纲，支持多层级的章节和场景划分。
*   **正文写作:** 在指定章节下，根据大纲和上下文，生成连贯的小说正文。

### 第二期新功能 (最新!)

*   **增强的构思与大纲:**
    *   支持生成更详细的梗概、角色卡和临时角色。
    *   能够按章节生成包含详细人物状态的精细化大纲，让故事结构更严谨。

*   **优化的创作流程:**
    *   创作正文时，能自动概括上下文，并利用所有详细大纲信息，有效提升故事的连贯性。

*   **健壮性提升:**
    *   引入了重试机制，增强了对外部大语言模型服务和数据库调用的稳定性，减少因网络波动或服务暂时不可用导致的失败。

*   **UI/UX 优化:**
    *   重新设计并美化了“小说创作”中的大纲视图，使其更直观、更易于使用，提升了用户的操作体验。

### 素材库 MVP（新增）

*   **素材录入：** 在后台新增素材实体与 API，前端提供“素材库”页面，可通过表单手动创建素材并维护标签与概要。
*   **文件上传解析：** 支持上传 `.txt` 文件，后端自动提取文本、切片、向量化并写入 Qdrant，实时返回导入作业状态。
*   **写作检索：** 在工作台新增“素材检索”面板，可按关键词检索最相关的素材片段，辅助写作。

### 素材库 V1

*   **混合检索：** 新增 `HybridSearchService`，结合 Qdrant 向量相似度与 MySQL FULLTEXT（ngram 分词），在后台统一去重融合；编辑器的自动建议与手动检索均默认走混合策略。
*   **结构化解析 + 人审：** 文件导入时调用 Spring AI（ChatClient）输出符合 `StructuredMaterial` 的 JSON，入库后状态默认为 `PENDING_REVIEW`，可在“素材审核”工作台校正结构化结果并批准/驳回。
*   **写作自动建议：** 小说创作页新增“素材建议”模块，监听正文内容后 1.5 秒自动检索相关片段，支持异步加载与空状态提示。

### 素材库 V2（当前阶段）

*   **ACL 权限控制：** 引入 `permission` 表与 AOP 校验注解，所有素材 API 均基于 Workspace/Material 粒度进行权限判定，前端通过 `Can` 组件动态展示操作按钮。
*   **素材去重与合并：** 后端提供重复检测与合并 API，前端支持批量查找相似素材并一键合并，将源素材归档。
*   **审计日志：** 建立检索日志与引用日志表，后台异步写入；素材详情页可查看引用历史。
*   **多路召回：** Qdrant 文档增加语义、标题、标签三路向量，检索时采用 Reciprocal Rank Fusion 融合 semantics / title / keywords / fulltext 结果。

## 技术栈

*   **后端:** Java, Spring Boot
*   **前端:** React, TypeScript, Vite, Tailwind CSS
*   **数据库:** (请根据实际情况填写, 例如: PostgreSQL, MySQL)
*   **向量库:** Qdrant (通过 Spring AI 集成)
*   **文本解析:** Apache Tika（用于导入 TXT 素材）
*   **AI 模型:** (请根据实际情况填写, 例如: OpenAI GPT-4, Anthropic Claude 3)

## 运行指南

### 1. 启动后端服务

```bash
# 进入后端项目目录
cd backend

# 运行 Spring Boot 应用
mvn spring-boot:run
```
后端服务将启动在 `http://localhost:8080`。
> 在启动前请确认已配置以下环境变量或应用配置：`OPENAI_API_KEY`（Embedding 模型）、`QDRANT_HOST` / `QDRANT_PORT`（向量库地址）、`MATERIAL_UPLOAD_DIR`（可选，自定义素材上传目录）。默认情况下 Qdrant 连接到 `localhost:6333`。

### 2. 启动前端应用

```bash
# 打开一个新的终端，进入前端项目目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```
前端应用将启动在 `http://localhost:5173`，并会自动在浏览器中打开。

> 新增的“素材库”入口位于首页导航以及工作台标签页内，需登录后访问。

### 前后端独立启动说明

- 访问入口：用户始终访问前端服务（如 `http://localhost:5173`）。
- 前端到后端：开发环境通过 Vite 代理将以 `/api` 开头的请求转发到后端 `http://localhost:8080`。
- 跨域设置：后端已在 `application-dev.properties` 中放行 `http://localhost:5173` 源，确保独立启动时可正常联调。
- 构建产物：前端构建输出到 `frontend/dist`，不再拷贝到后端 `resources/static`。
- 生产部署建议：前端静态资源与后端 API 独立部署；用反向代理将 `/api` 指向后端，或在前端配置绝对的 API 基础地址。
