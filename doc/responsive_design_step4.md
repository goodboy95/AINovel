# 响应式改造 Step 4 —— 大纲工作台模块

## 1. 背景与目标

大纲工作台是创作流程中最复杂的模块之一，当前采用三列布局（故事选择 / 树形结构 / 节点编辑器），在桌面端尚可使用，但在移动端与平板上因空间受限而不可用。本阶段目标是重新设计信息架构，使大纲编排与节点编辑在不同设备上均具备良好的可读性与操作效率。

### 1.1 目标拆解

- 将三列布局拆解为可折叠/切换的多个面板，在移动端按照流程逐步呈现。
- 引入搜索与过滤功能，提升在狭小屏幕上查找节点的效率。
- 重构节点编辑表单与 AI 生成功能，使其在移动端具备清晰的输入输出区。
- 保证大纲树的交互（展开、选择、拖拽）在不同断点下流畅。

## 2. 范围界定

| 子模块 | 主要文件 | 改造要点 |
| --- | --- | --- |
| 大纲工作台容器 | `components/OutlinePage.tsx`、`components/OutlineLayout.tsx` *(新增)* | 面板拆分、导航切换、底部操作栏 |
| 大纲树视图 | `components/OutlineTreeView.tsx`、`components/OutlineTreeNode.tsx` | 树形结构自适应、搜索与过滤、滚动容器 |
| 节点编辑区域 | `components/ChapterEditForm.tsx`、`components/SceneEditForm.tsx`、`components/OutlineAIControls.tsx` | 表单排版、按钮分组、移动端弹层 |
| 操作面板 | `components/OutlineToolbar.tsx`、`components/OutlineHistoryDrawer.tsx` *(新增)* | 快捷操作、历史记录/版本对比 |

## 3. 体验设计

### 3.1 面板结构

- **桌面端 (`lg` 及以上)**
  - 采用左右分栏：左侧为故事/大纲选择与树结构（宽 320-360px），右侧为节点编辑区（占剩余空间）。
  - 支持拖拽调整左右宽度，使用 CSS Grid 或 `resizable` 容器。
- **平板 (`md`)**
  - 默认展示树结构 + 节点编辑，故事选择折叠到顶部 `Collapse` 中。
  - 允许用户在设置中切换「树优先」或「编辑优先」模式。
- **移动端 (`xs/sm`)**
  - 使用 `Tabs` 或 `Segmented` 让用户在三个面板之间切换：
    1. 故事/大纲选择
    2. 大纲树（支持搜索）
    3. 节点编辑
  - 底部固定操作栏放置「新增节点」「保存」「AI 生成」等按钮。

### 3.2 大纲树交互

- 列表容器高度适配：在移动端占满屏幕减去头部/操作栏高度，可滚动。
- 节点名称过长时自动换行或显示省略号，点击可展开详情。
- 支持在移动端长按节点呼出操作面板（移动、删除、新增子节点）。
- 搜索栏位于树结构顶部，支持关键字过滤并高亮匹配节点。

### 3.3 节点编辑

- 表单采用分区布局：基础信息（标题、类型、状态） + 内容编辑 + AI 工具。
- 移动端将 AI 工具折叠为抽屉，在需要时调起。
- 富文本编辑器在移动端提供全屏模式，隐藏非必要工具栏。
- 操作按钮（保存、生成、撤销）统一放至顶部工具条或底部操作栏。

### 3.4 历史与协同

- 引入 `OutlineHistoryDrawer` 展示生成/编辑历史，移动端以全屏 Drawer 呈现。
- 支持在不同断点下查看历史详情，提供对比或回滚入口。

## 4. 技术方案

### 4.1 布局与容器

- `OutlineLayout`
  - 提供 `panels` 配置，包含 `id`、`title`、`icon`、`render`、`priorityBreakpoints`。
  - 在桌面端使用 CSS Grid：`grid-template-columns: auto 1fr`。
  - 在移动端根据 `priorityBreakpoints` 渲染 Tabs/Segmented，与 Step 2 的导航保持一致风格。
- 使用 CSS 变量 `--outline-sidebar-width` 控制树结构宽度，允许用户拖拽调整（桌面端）。

### 4.2 大纲树视图

- 优化现有树组件，拆分节点组件，减少不必要的重渲染。
- 搜索功能通过前端过滤实现，结果为空时展示提示卡片。
- 支持折叠状态持久化：在本地存储记录用户展开的节点。
- 移动端长按交互可使用 `useLongPress` Hook，实现 500ms 触发的上下文菜单。

### 4.3 节点编辑表单

- 使用 `ResponsiveStack`（来自 Step 3）控制表单字段排列。
- 移动端富文本编辑器进入全屏时，将工具栏移动到底部或顶部浮层。
- AI 生成控制面板抽象成 `OutlineAIControls`，根据断点切换展示模式（侧边栏/Drawer）。
- 在提交保存时，若数据未变更则禁用按钮，提供节流保护。

### 4.4 操作面板与历史

- `OutlineToolbar` 提供常用操作按钮，自适应显示文字或仅图标。
- `OutlineHistoryDrawer` 使用 `Drawer` 组件，在桌面端右侧抽屉，移动端全屏。
- 历史记录支持分页或虚拟滚动，避免大量记录导致性能问题。

## 5. 实施步骤与排期建议

1. **设计确认 (0.5 人日)**：对齐移动端/桌面端线框、长按菜单与历史面板交互。
2. **基础布局开发 (1 人日)**：实现 `OutlineLayout`、Tabs 切换、CSS 变量及拖拽逻辑。
3. **大纲树改造 (1 人日)**：
   - 拆分节点组件、实现搜索与长按菜单。
   - 处理滚动与折叠状态持久化。
4. **节点编辑与 AI 控制 (1.5 人日)**：
   - 表单排版与移动端 Drawer。
   - 富文本编辑器全屏模式、AI 控制面板重构。
5. **历史面板与联调 (0.5 人日)**：实现 Drawer、验证操作流程。
6. **测试与验收 (0.5 人日)**：涵盖断点、数据保存、拖拽、长按菜单等。

## 6. 风险与应对

| 风险 | 描述 | 缓解措施 |
| --- | --- | --- |
| 富文本编辑器在移动端性能差 | 全屏模式可能导致滚动卡顿 | 延迟加载编辑器、降低默认工具栏数量、按需加载插件 |
| 拖拽与触控冲突 | 桌面端拖拽逻辑与移动端滑动手势可能冲突 | 分断点启用：仅在 `lg` 以上允许拖拽，移动端使用操作菜单调整顺序 |
| 历史记录数据量大 | Drawer 渲染过多历史导致性能下降 | 分页加载 + 虚拟列表，必要时限制可回溯条数 |

## 7. 验收标准与测试计划

1. **功能验收**
   - 移动端可通过 Tabs 在故事选择、树结构、节点编辑之间切换，无明显卡顿。
   - 节点搜索在 500ms 内返回结果，支持高亮匹配。
   - 长按节点可打开操作菜单，执行后 UI 同步更新。
   - 历史 Drawer 可打开查看历史记录，支持回滚/比较功能（若已有）。
2. **测试清单**
   - 单元测试：`OutlineLayout` 渲染逻辑、`OutlineTreeView` 搜索过滤、长按 Hook。
   - 集成测试：创建/编辑节点、保存、查看历史流程。
   - 手动测试：真机验证滚动、Drawer、全屏编辑器交互，检查键盘弹起行为。

完成 Step 4 后，大纲编辑流程在不同设备上均可用，为最终的正文创作与跨模块弹窗改造奠定基础。
