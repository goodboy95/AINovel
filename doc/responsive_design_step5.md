# 响应式改造 Step 5 —— 小说创作模块与弹窗体系

## 1. 背景与目标

此前步骤已完成基础布局、工作台框架、故事构思/管理、大纲工作台的响应式改造。本阶段聚焦最终的创作核心——小说创作模块及跨模块弹窗，并统一测试与验收标准，标志响应式改造的收尾。

### 1.1 目标拆解

- 小说创作界面（Manuscript Writer）支持在手机端通过 Tabs/Segmented 切换大纲、正文、角色视图。
- 角色状态侧栏改造为列表/Drawer，移动端操作便捷。
- 所有跨模块弹窗（角色详情、AI 打磨、设定对话等）在移动端提供全屏 Drawer 或自适应宽度。
- 制定并执行最终的回归测试计划，涵盖所有断点与核心操作路径。

## 2. 范围界定

| 模块 | 主要文件 | 改造要点 |
| --- | --- | --- |
| 小说创作主体 | `components/ManuscriptWriter.tsx`、`components/ManuscriptLayout.tsx` *(新增)* | 视图切换、内容容器、底部操作栏 |
| 角色状态 | `components/CharacterStatusSidebar.tsx`、`components/CharacterStatusCard.tsx` | 移动端列表、状态展示优化 |
| 弹窗体系 | `components/modals/*`、`components/dialogs/*` | Drawer 化、全屏模式、按钮布局 |
| 公共资源 | `src/hooks/useSafeArea.ts` *(新增)*、`src/styles/modal-responsive.css` *(新增)* | 处理刘海屏、安全区、弹窗样式 |
| 测试文档 | `doc/responsive_testing_checklist.md` *(新增)* | 回归测试清单、设备矩阵 |

## 3. 体验设计

### 3.1 小说创作界面

- **桌面端 (`lg` 及以上)**：
  - 保持三列布局（大纲树、正文编辑器、角色状态），但使用 `flex: 1` 控制自适应宽度。
  - 提供面板折叠按钮，允许用户隐藏大纲或角色侧栏。
- **平板 (`md`)**：
  - 默认显示正文编辑器，其他面板通过折叠或 Tabs 切换。
  - Tabs 放置于顶部，带图标表示不同视图。
- **移动端 (`xs/sm`)**：
  - 使用 `Segmented` 或自定义 Tabs 切换三个视图：`Outline`、`Manuscript`、`Characters`。
  - 正文编辑器提供全屏模式，工具栏最简化（加粗、斜体、标题、列表、撤销）。
  - 底部操作栏放置主要操作（生成、保存、预览），并提供快捷入口打开角色 Drawer。

### 3.2 角色状态呈现

- 角色列表在手机上以卡片形式纵向排列，展示头像、心情、目标等关键信息。
- 支持在卡片内折叠查看详细属性或打开 Drawer 查看完整信息。
- 在桌面端继续以侧栏形式展示，但宽度可调整，支持搜索/筛选。

### 3.3 弹窗与对话框

- 所有 Modal 在 `xs/sm` 断点下切换为 `Drawer` 或全屏 Modal，顶部提供关闭按钮和标题。
- Modal 内容使用 `ResponsiveCard`、`ResponsiveStack` 保证间距，底部按钮在移动端堆叠为垂直布局。
- 对于 AI 打磨、剧情续写等流程：
  - 第一步（输入参数）与结果展示分屏处理，移动端使用步骤导航或上下结构。
  - 结果区域支持复制、插入正文、收藏等操作，按钮置于底部。

### 3.4 安全区与键盘适配

- 引入 `useSafeArea` Hook，使用 `env(safe-area-inset-*)` 保障刘海屏安全区。
- 在移动端输入时监听键盘弹起，自动调整底部操作栏与 Drawer 高度，避免遮挡输入框。

## 4. 技术方案

### 4.1 小说创作布局

- `ManuscriptLayout`
  - 接受 `panels`（`outline`, `editor`, `characters`）配置，内置断点切换逻辑。
  - 在移动端渲染 Tabs + `SwipeableViews`（可选），提升切换体验。
  - 提供 `onPanelChange` 回调以记录用户最近访问的面板。
- 正文编辑器
  - 对接现有富文本或 Markdown 编辑器，增加移动端工具栏配置。
  - 在全屏模式下将编辑器放入 `Portal`，与底部操作栏解耦。

### 4.2 角色状态组件

- 抽象 `CharacterStatusCard`
  - 显示核心属性与进度条。
  - 提供「查看详情」「更新状态」按钮，移动端点击后打开 Drawer。
- 角色 Drawer
  - 包含详情、关系、最近事件三个 Tab。
  - 支持在 Drawer 内直接修改状态并保存。

### 4.3 弹窗响应式

- 新增 `modal-responsive.css`，定义 Modal/Drawer 的断点样式：
  - `lg` 以上保留默认宽度（720-960px）。
  - `md` 以下宽度设为 `100vw`、高度 `100vh`，标题栏固定。
  - 底部按钮区域使用 `position: sticky`，便于操作。
- 对每个 Modal 重构 props，支持 `fullScreen`、`placement`、`footerLayout` 等选项。
- 共用 `useSafeArea` 计算底部 padding，避免遮挡。

### 4.4 测试清单与自动化

- 创建 `doc/responsive_testing_checklist.md`（本阶段输出），列出：
  - 设备矩阵：iPhone 12、iPhone SE、Pixel 6、iPad、13" 笔记本、27" 显示器。
  - 场景：创作流程、角色编辑、AI 弹窗、历史查看、保存/生成等。
  - 验收指标：无横向滚动、按钮可点、文本可读、切换平滑。
- 自动化建议：
  - 使用 Playwright 编写关键路径脚本，在 375px 与 1280px 下执行生成/保存流程。
  - 引入 Percy 或 Loki 做视觉对比（可选）。

## 5. 实施步骤与排期建议

1. **设计与交互确认 (0.5 人日)**：对齐移动端 Tabs、弹窗样式、全屏编辑器交互。
2. **布局与组件开发 (1.5 人日)**：实现 `ManuscriptLayout`、角色状态卡片、`useSafeArea`。
3. **弹窗重构 (1.5 人日)**：统一 Modal/Drawer 样式、行为，确保所有弹窗在移动端正常工作。
4. **测试清单落地 (0.5 人日)**：整理文档、编写关键路径自动化脚本（若投入自动化）。
5. **回归与验收 (0.5 人日)**：执行测试清单，收集问题并修复。

## 6. 风险与应对

| 风险 | 描述 | 缓解措施 |
| --- | --- | --- |
| 编辑器在移动端可用性差 | 富文本操作复杂，可能影响体验 | 增加 Markdown 模式或简化工具栏；提供手势操作提示 |
| 弹窗重构影响业务逻辑 | 改造涉及大量现有 Modal | 分批迁移：先改造通用 Modal 基类，再逐个替换；保持 API 兼容 |
| 安全区适配难度大 | 不同设备安全区高度不同 | 使用 `env()` + `useSafeArea` 获取实际数值，提供兜底 padding |

## 7. 验收标准与测试计划

1. **功能验收**
   - 移动端在小说创作模块中可完成：查看大纲、编辑正文、查看角色状态、调用 AI 弹窗并插入结果。
   - 所有弹窗在 375px 宽度下无横向滚动，顶部/底部按钮可触达。
   - 底部操作栏与安全区适配正确，键盘弹起时不遮挡输入框。
2. **测试清单**
   - 单元测试：`ManuscriptLayout` Tabs 切换、`useSafeArea` 返回值、Modal 全屏模式渲染。
   - 自动化（若实施）：375px 下执行生成正文、保存草稿流程；1280px 下执行角色编辑。
   - 手动测试：真机验证长文输入、拖动光标、复制/粘贴等细节。

完成 Step 5 后，响应式改造全部收尾。需安排一次跨团队评审与回顾，梳理开发过程中沉淀的组件与规范，并更新官方文档与培训资料。
