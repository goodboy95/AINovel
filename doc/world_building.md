# 世界构建模块总体设计文档

## 1. 背景与愿景

现有工作台专注于故事构思、大纲与正文创作，缺乏一套系统化的世界观资产管理能力。随着用户需求从单本作品扩展到系列化、跨媒介创作，迫切需要提供一个能够长期沉淀、复用并驱动 AI 创作的“世界构建”模块。本次设计旨在：

- 为世界设定提供独立空间，避免与工作台混杂。
- 将世界观拆解为多个可维护的信息模块，覆盖宇宙观、地理、社会、历史、文化、经济与剧情钩子。
- 提供 AI 协助的批量生成、逐字段优化、草稿/正式两种保存方式与异步生成进度管理。
- 让已经正式创建的世界无缝融入工作台的所有创作流程，成为 AI 提示词的高质量上下文。

## 2. 目标与范围

| 目标 | 说明 |
| --- | --- |
| 独立世界构建模块 | 单独的路由与导航入口，顶部提供世界/草稿管理，底部为分模块编辑区。 |
| 模块化信息结构 | 至少 7 个主信息模块，模块下再细分字段，搭配问号提示与字数建议。 |
| AI 辅助能力 | 模块级“一键生成”、字段级“AI 优化”，正式创建时自动生成“完整信息”。 |
| 异步发布流程 | 草稿即时保存；正式创建触发后台队列生成，提供进度弹窗、失败重试、断点续传。 |
| 提示词配置体系 | 在用户设置中区分“工作台提示词配置”“世界构建提示词配置”，并提供世界构建专属帮助文档。 |
| 工作台集成 | 在故事构思、大纲工作台、小说创作页面可选择已正式创建的世界，自动将世界完整信息注入提示词上下文。 |

超出范围：角色卡重构、跨用户共享世界、复杂版本管理将在后续迭代评估。

## 3. 信息架构概览

### 3.1 页面布局

1. **顶栏（世界管理区）**：
   - “新建世界”按钮：创建空白世界草稿并切换到编辑视图。
   - 世界选择器：下拉/列表切换已正式创建的世界（按最近更新排序）。
   - 草稿抽屉：展示所有草稿，提供继续编辑、重命名、删除入口。
   - 快速信息：显示当前世界的状态（草稿/生成中/已创建）、最近更新时间、主题标签。

2. **编辑区（Tab 结构）**：
   - Tab 页为信息模块，按顺序依次呈现“宇宙观与法则”“地理与生态”“社会与政治”“历史与传说”“文化与日常”“经济与科技”“势力与剧情钩子”。
   - 模块内以分组卡片展示字段：字段名称、文本域输入框、字数提示、问号图标（Tooltip）与“AI 优化”按钮。
   - 模块顶部提供“AI 自动生成本模块”“标记为需重写”“同步状态”提示。

3. **底部操作条**：实时提示草稿保存状态，提供“保存草稿”“正式创建世界”按钮以及生成状态提醒。

### 3.2 信息模块结构

- **模块间依赖**：整体建议按序填写，但允许自由跳转。正式创建时要求所有字段非空。字段详细说明与提示词模板见《Step 1》文档。
- **字段类型**：默认使用多行文本域，支持 Markdown 预览（后续迭代）；长度建议 200–500 字，Tooltip 中给出参考范围。
- **状态标记**：字段层面记录“待保存/已保存/需重生成”状态，模块层面汇总为“未完成/已完成/待生成完整信息”。

## 4. 核心业务流程

### 4.1 新建与草稿保存

1. 用户点击“新建世界”，填写世界名称、一句话概述、主题标签等基础信息。
2. 系统立即创建草稿记录并加载全部模块（空内容）。
3. 用户在任意字段编辑时自动触发本地保存提示；点击“保存草稿”或离开模块时调用后端保存接口。
4. 草稿状态下可随时删除；正式世界禁止直接删除，仅允许复制或归档（后续迭代考虑）。

### 4.2 正式创建与生成

1. 用户点击“正式创建世界”。
2. 后端校验所有字段是否填写完成；若存在空值，前端弹窗列出未填字段并定位到对应模块。
3. 若为新世界：
   - 将世界状态标记为 `GENERATING`。
   - 为每个模块创建“完整信息”生成任务（串行队列）。
4. 若为已有世界的更新：
   - 检测本次编辑的字段差异，生成对应模块任务，其余模块复用旧完整信息。
   - 世界状态切换为 `GENERATING`，列表视图显示“生成中”。
5. 弹出“世界完整信息生成进度”窗口，展示各模块状态（等待中/生成中/已生成/失败）。
6. 任务全部成功后：
   - 更新模块的完整信息文本与时间戳。
   - 世界状态改为 `ACTIVE`，记录版本号+发布时间。
   - 关闭进度窗口并提示成功。
7. 若某模块失败，用户可在进度窗口中点击“重新排队”，任务状态回到等待中。

### 4.3 断点续传

- 生成过程中若用户关闭页面，后台任务继续执行。
- 重新打开世界构建模块并选中状态为 `GENERATING` 的世界时，自动弹出进度窗口并开始轮询最新状态。

### 4.4 工作台集成

1. 在故事构思、大纲工作台、小说创作页面新增“选择世界”下拉框，仅列出状态为 `ACTIVE` 的世界。
2. 选择世界后：
   - 前端调用接口获取世界元信息与各模块完整信息。
   - 请求 AI 的后端 Prompt Builder 将世界信息注入上下文，具体插值变量见《Step 6》与提示词帮助文档。
3. 若用户取消选择世界或所选世界被重新生成，后端自动清除或更新缓存的世界上下文。

## 5. 技术架构概览

### 5.1 后端总体方案

- 新增世界相关领域模型（World、WorldModule、WorldGenerationJob 等），使用 JSON 字段存储模块内容、字段值与完整信息。
- 提供独立的 `WorldController`/`WorldGenerationController` 处理 CRUD、草稿管理、生成进度与 AI 操作。
- 引入 `WorldPromptTemplateService`，基于现有模板引擎扩展世界构建的默认模板、用户自定义模板、插值变量元数据。
- 通过数据库任务表+调度器实现串行 AI 生成，支持失败重试、断点恢复。

### 5.2 前端总体方案

- 新增 `/worlds` 路由及导航入口，采用 Ant Design Tabs + 自定义模块编辑组件。
- 使用 React Query 管理世界数据、模块内容、生成状态的拉取与缓存。
- 复用现有 AI 优化弹窗组件，针对世界构建字段提供专属提示词。
- 引入独立的“世界完整信息生成进度”模态框组件，支持状态流转与重试。

### 5.3 AI 与提示词

- 模块级自动生成：根据世界基础信息与已填写字段，生成 JSON 结果覆盖整个模块。
- 字段级优化：复用现有 `/refine` 接口，传入世界构建专属上下文与提示词，强调补足逻辑、对齐世界规则。
- 正式创建：按模块顺序生成完整信息，写入 `world_modules.full_content` 字段，供工作台调用。
- 提示词模板支持插值表达式（`${world.name}`、`${module.fields.cosmos_structure}` 等），默认模板详见《Step 1》，可在《Step 5》配置页面覆盖。

### 5.4 数据状态

- 世界状态：`DRAFT`、`GENERATING`、`ACTIVE`、`ARCHIVED`（预留）。
- 模块状态：`EMPTY`、`IN_PROGRESS`、`READY`（字段填写完成）、`AWAITING_GENERATION`、`GENERATING`、`COMPLETED`、`FAILED`。
- 任务状态：`WAITING`、`RUNNING`、`SUCCEEDED`、`FAILED`、`CANCELLED`。
- 版本字段：`world.version` 自增，用于判断前端缓存是否过期；`world_modules.contentHash` 用于确定是否需要重新生成。

## 6. 提示词策略概览

- 《Step 1》定义了每个模块的字段拆分、Tooltip 文案、AI 自动生成模板、字段优化重点以及“世界完整信息”生成模板。
- 模块级提示词强调结构化 JSON 返回、允许读取其他模块的摘要以保持一致性。
- 字段级优化模板提供模块内共用骨架 + 字段专属关注点，保障 AI 输出聚焦该字段核心维度。
- 正式创建阶段的提示词要求输出长篇叙述，统一段落格式，避免 Markdown 头部，确保可直接注入工作台上下文。

## 7. 配置与帮助文档

- 用户设置侧边栏：将原“提示词配置”改名为“工作台提示词配置”，新增“世界构建提示词配置”。
- 新页面支持逐模块编辑“AI 自动生成模板”“完整信息模板”，可重置为默认值。
- 新增“世界构建提示词编写帮助”页面/文档，介绍可用变量、函数、示例与最佳实践，帮助用户编写模板。
- 世界构建模板与工作台模板的插值变量互不干扰，使用不同命名空间（`world.*` / `module.*` / `workspace.world.*`）。

## 8. 里程碑与交付物

| 阶段 | 关注点 |
| --- | --- |
| 《Step 1》世界模块与提示词定义 | 明确信息架构、字段拆分、Tooltip、提示词模板与上下文结构。 |
| 《Step 2》后端领域模型与基础 API | 建表、实体、仓储、模块 CRUD、草稿/状态流转、DTO。 |
| 《Step 3》AI 集成与生成队列 | 模块自动生成、字段优化、正式创建队列、进度查询与重试。 |
| 《Step 4》前端世界构建界面 | 页面路由、交互组件、状态管理、Tooltip 与按钮逻辑。 |
| 《Step 5》提示词配置与帮助 | 新配置页、后端模板管理、默认模板落地、帮助文档。 |
| 《Step 6》工作台集成 | 世界选择 UI、后端上下文注入、默认提示词更新、插值表达式扩展。 |

完成以上步骤后，即可交付具备闭环体验的世界构建功能。

## 9. 风险与对策

| 风险 | 描述 | 应对策略 |
| --- | --- | --- |
| 模块字段数量多导致用户填写负担重 | 35 个字段可能造成信息冗长 | 提供 AI 自动生成与字段级优化、保存草稿、在 Tooltip 中标明“必填/选填”与字数建议。 |
| AI 输出不稳定 | JSON 解析失败或内容偏题 | 在提示词中强化格式要求、增加重试与字段校验；失败时允许用户手动编辑后重新排队。 |
| 生成队列堵塞 | 串行执行导致等待时间过长 | 支持后台断点续传、显示预计耗时提示，并预留批量处理/并行优化空间。 |
| 提示词变量冲突 | 世界构建与工作台的插值变量可能混淆 | 在模板引擎中使用命名空间隔离，并提供帮助文档。 |
| 工作台上下文过大 | 将全部世界信息注入可能导致提示词过长 | 支持按需选择模块插入（默认全部，可配置），并在后端做长度截断/摘要策略。 |

---

本文档概述整体设计，具体实现细节请参阅分阶段文档：《world_building_step1.md》至《world_building_step6.md》。
